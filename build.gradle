///////////////////////////////////////////////////
//                                               //
//             Dependency Details                //
//                                               //
///////////////////////////////////////////////////

plugins {
  id "com.moowork.node" version "0.12"
}

apply plugin: 'maven-publish'
apply plugin: 'groovy'

import groovy.json.JsonSlurper

///////////////////////////////////////////////////
//                                               //
//               Project Details                 //
//                                               //
///////////////////////////////////////////////////

allprojects {

  // Read kibi version from the package.json file
  File packageJson = new File(projectDir, "package.json")
  def json = new JsonSlurper().parseText(packageJson.text)

  group = 'solutions.siren'
  version = json.kibi_version
}

///////////////////////////////////////////////////
//                                               //
//                    NodeJS                     //
//                                               //
///////////////////////////////////////////////////

node {
  // Version of node to use.
  version = '0.12.10'

  // Version of npm to use.
  npmVersion = '2.14.9'

  // Base URL for fetching node distributions (change if you have a mirror).
  distBaseUrl = 'https://nodejs.org/dist'

  // If true, it will download node using above parameters.
  // If false, it will try to use globally installed node.
  download = true

  // Set the work directory for unpacking node
  workDir = file("${buildDir}/nodejs")

  // Set the work directory where node_modules should be located
  nodeModulesDir = file("${projectDir}")
}

///////////////////////////////////////////////////
//                                               //
//                  Main Tasks                   //
//                                               //
///////////////////////////////////////////////////

task build(dependsOn: [npmInstall, npm_run_test, npm_run_build]) << {}

npm_run_test.mustRunAfter npmInstall
npm_run_build.mustRunAfter npm_run_test

///////////////////////////////////////////////////
//                                               //
//                  Publishing                   //
//                                               //
///////////////////////////////////////////////////

publishing {
  publications {

    /**
     * Install Kibi distributions into maven local
     */

    darwinX64(MavenPublication) {
      artifact new File("${projectDir}/target", "kibi-${project.version}-darwin-x64.zip")
      groupId project.group
      artifactId "kibi-core"
      version "${project.version}-darwin-x64"
    }

    linuxX64(MavenPublication) {
      artifact new File("${projectDir}/target", "kibi-${project.version}-linux-x64.zip")
      groupId project.group
      artifactId "kibi-core"
      version "${project.version}-linux-x64"
    }

    linuxX86(MavenPublication) {
      artifact new File("${projectDir}/target", "kibi-${project.version}-linux-x86.zip")
      groupId project.group
      artifactId "kibi-core"
      version "${project.version}-linux-x86"
    }

    windows(MavenPublication) {
      artifact new File("${projectDir}/target", "kibi-${project.version}-windows.zip")
      groupId project.group
      artifactId "kibi-core"
      version "${project.version}-windows"
    }

    windows64(MavenPublication) {
      artifact new File("${projectDir}/target", "kibi-${project.version}-windows64.zip")
      groupId project.group
      artifactId "kibi-core"
      version "${project.version}-windows64"
    }

  }
}
